!function(e){var t={};function n(a){if(t[a])return t[a].exports;var i=t[a]={i:a,l:!1,exports:{}};return e[a].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,a){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:a})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}();var i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._tokensPolicy="last",this._lastTokenFound=null,this._tokensFound=[],this._tokensSelection=[],this._notificationsEnabled=!0,this._loggingEnabled=!0}return a(e,[{key:"load",value:function(){var e=this;return new Promise(function(t){var n=Object.keys(e).map(function(e){return e.substring(1)});chrome.storage.sync.get(n,function(a){Object.assign(e,a);var i={},o=!0,s=!1,r=void 0;try{for(var l,u=n[Symbol.iterator]();!(o=(l=u.next()).done);o=!0){var c=l.value;i[c]={oldValue:e["_"+c],newValue:a[c]?a[c]:e["_"+c]}}}catch(e){s=!0,r=e}finally{try{!o&&u.return&&u.return()}finally{if(s)throw r}}e._onChangedCallback&&e._onChangedCallback(i),e.loggingEnabled&&console.log("Config set to: "+JSON.stringify(e,null,4)),chrome.storage.onChanged.addListener(function(t,n){var a=!1;for(var i in t)e["_"+i]!==t[i].newValue&&(e["_"+i]=t[i].newValue,a=!0,(e._loggingEnabled||"loggingEnabled"===i)&&console.log("Config '"+i+"' changed to "+t[i].newValue+"."));a&&e._onChangedCallback&&e._onChangedCallback(t)}),t()})})}},{key:"notificationsEnabled",get:function(){return this._notificationsEnabled},set:function(e){if(this._notificationsEnabled!==e){var t={notificationsEnabled:{oldValue:this._notificationsEnabled,newValue:e}};this._notificationsEnabled=e,chrome.storage.sync.set({notificationsEnabled:e}),this._onChangedCallback&&this._onChangedCallback(t)}}},{key:"lastTokenFound",get:function(){return this._lastTokenFound},set:function(e){if(this._lastTokenFound!==e){var t={lastTokenFound:{oldValue:this._lastTokenFound,newValue:e}};this._lastTokenFound=e,chrome.storage.sync.set({lastTokenFound:e}),this._onChangedCallback&&this._onChangedCallback(t)}}},{key:"tokensPolicy",get:function(){return this._tokensPolicy},set:function(e){if(this._tokensPolicy!==e){var t={tokensPolicy:{oldValue:this._tokensPolicy,newValue:e}};this._tokensPolicy=e,chrome.storage.sync.set({tokensPolicy:e}),this._onChangedCallback&&this._onChangedCallback(t)}}},{key:"tokensFound",get:function(){return this._tokensFound},set:function(e){if(this._tokensFound!==e){var t={tokensFound:{oldValue:this._tokensFound,newValue:e}};this._tokensFound=e,chrome.storage.sync.set({tokensFound:e}),this._onChangedCallback&&this._onChangedCallback(t)}}},{key:"tokensSelection",get:function(){return this._tokensSelection},set:function(e){if(this._tokensSelection!==e){var t={tokensSelection:{oldValue:this._tokensSelection,newValue:e}};this._tokensSelection=e,chrome.storage.sync.set({tokensSelection:e}),this._onChangedCallback&&this._onChangedCallback(t)}}},{key:"loggingEnabled",get:function(){return this._loggingEnabled},set:function(e){if(this._loggingEnabled!==e){var t={loggingEnabled:{oldValue:this._loggingEnabled,newValue:e}};this._loggingEnabled=e,chrome.storage.sync.set({loggingEnabled:e}),this._onChangedCallback&&this._onChangedCallback(t)}}},{key:"onChanged",set:function(e){this._onChangedCallback=e}}]),e}();t.default=new i},function(e,t,n){"use strict";var a=l(n(0)),i=l(n(2)),o=l(n(3)),s=l(n(4)),r=l(n(5));function l(e){return e&&e.__esModule?e:{default:e}}var u=" - ",c={},d=new RegExp(u+"Deezer(?="+u+")","g");function h(e){var t=e.split(u);return 3===t.length?t[1]+u+t[0]+u+t[2]:e.replace(d,"")}var f=new o.default("www.deezer.com",3e3);f.onCurrentAudibleTabChange=function(e){var t=Object.values(c);if(t.length>0){var n=e?h(e.title):null,o=!0,s=!1,r=void 0;try{for(var l,u=t[Symbol.iterator]();!(o=(l=u.next()).done);o=!0){l.value.sendStatusUpdate(n)}}catch(e){s=!0,r=e}finally{try{!o&&u.return&&u.return()}finally{if(s)throw r}}a.default.notificationsEnabled&&i.default.notify(chrome.i18n.getMessage("status")+": "+(n||chrome.i18n.getMessage("statusNone")),e?function(){chrome.tabs.update(e.id,{active:!0}),a.default.loggingEnabled&&console.log("Status notification '"+n+"' clicked, tab switched to "+e.id+".")}:null)}else a.default.loggingEnabled&&console.log("Status changed but no Discord token set.")};var b=new r.default;function _(e){for(var t in c)e.includes(t)||(c[t].sendStatusUpdate(null),c[t].close(),delete c[t],a.default.loggingEnabled&&console.log("Removed gateway for token "+t));e.forEach(function(e){if(!c[e]){var t=new s.default(e);c[e]=t;var n=f.currentAudibleTab,i=n?h(n.title):null;t.sendStatusUpdate(i),a.default.loggingEnabled&&console.log("Added gateway for token "+e)}})}b.onFound=function(e){if(a.default.lastTokenFound!==e&&(a.default.lastTokenFound=e),!a.default.tokensFound.includes(e)){var t=a.default.tokensFound.slice();t.push(e),a.default.tokensFound=t}},a.default.onChanged=function(e){switch(console.log("changeInfo: "+JSON.stringify(e,null,4)),a.default.tokensPolicy){case"last":_(a.default.lastTokenFound?[a.default.lastTokenFound]:[]);break;case"all":_(a.default.tokensFound);break;case"selection":_(a.default.tokensSelection)}},a.default.load().then(function(){b.start(),f.start()})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),i=function(e){return e&&e.__esModule?e:{default:e}}(n(0));var o=chrome.i18n.getMessage("appName"),s=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return a(e,[{key:"notify",value:function(e,t){if(i.default.notificationsEnabled){var n="function"==typeof t;chrome.notifications.create({type:"basic",iconUrl:"discord48.png",title:o,message:e,isClickable:n},function(e){if(n){var a=function(n){n===e&&t()};chrome.notifications.onClicked.addListener(a),chrome.notifications.onClosed.removeListener(a)}}),i.default.loggingEnabled&&console.log("New notification '"+e+"'")}}}]),e}();t.default=new s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},i=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),o=function(e){return e&&e.__esModule?e:{default:e}}(n(0));var s=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._hostname=t,this._tabsQuery={url:"*://"+t+"/*"},this._debounceDelay=n,this._tabs={},this._started=!1,this._listeners={onCreated:this._onTabCreated.bind(this),onUpdated:this._onTabUpdated.bind(this),onReplaced:this._onTabReplaced.bind(this),onRemoved:this._onTabRemoved.bind(this)}}return i(e,[{key:"start",value:function(){if(!this._started){for(var e in this._initTabs(),this._listeners)chrome.tabs[e].addListener(this._listeners[e]);this._started=!0}}},{key:"stop",value:function(){if(this._started){for(var e in clearTimeout(this._debounceTimer),this._listeners)chrome.tabs[e].removeListener(this._listeners[e]);this._started=!1,o.default.loggingEnabled&&console.log("AudibleTabTitleTracker stopped")}}},{key:"_initTabs",value:function(){this._tabs={},chrome.tabs.query(this._tabsQuery,this._initTabsFound.bind(this))}},{key:"_initTabsFound",value:function(e){var t=!0,n=!1,a=void 0;try{for(var i,s=e[Symbol.iterator]();!(t=(i=s.next()).done);t=!0){var r=i.value;this._setTrackedTab(r)}}catch(e){n=!0,a=e}finally{try{!t&&s.return&&s.return()}finally{if(n)throw a}}this._checkForCurrentAudibleTabChange(),o.default.loggingEnabled&&console.log("AudibleTabTitleTracker started:\n - host: "+this._hostname+"\n - debounce delay: "+this._debounceDelay+"\n - "+Object.keys(this._tabs).length+" tabs: "+JSON.stringify(this._tabs,null,4))}},{key:"_hostnameMatches",value:function(e){try{return new URL(e).hostname===this._hostname}catch(e){return!1}}},{key:"_setTrackedTab",value:function(e){this._tabs[e.id]={id:e.id,title:e.title,audible:e.audible}}},{key:"_onTabCreated",value:function(e){this._hostnameMatches(e.url)&&(this._setTrackedTab(e),e.audible&&this._checkForCurrentAudibleTabChange())}},{key:"_onTabUpdated",value:function(e,t,n){if(e in this._tabs){var a=!1;"url"in t&&!this._hostnameMatches(n.url)?(delete this._tabs[e],a=!0):("title"in t&&(this._tabs[e].title=t.title,a=!0),"audible"in t&&(this._tabs[e].audible=t.audible,a=!0)),a&&this._checkForCurrentAudibleTabChange()}else this._onTabCreated(n)}},{key:"_onTabReplaced",value:function(e,t){t in this._tabs&&(this._tabs[e]=this._tabs[t],this._tabs[e].id=e,delete this._tabs[t],this._checkForCurrentAudibleTabChange())}},{key:"_onTabRemoved",value:function(e,t){e in this._tabs&&(delete this._tabs[e],this._checkForCurrentAudibleTabChange())}},{key:"_findCurrentAudibleTab",value:function(){return Object.values(this._tabs).find(function(e){return e.audible})}},{key:"_checkForCurrentAudibleTabChange",value:function(){var e=this._findCurrentAudibleTab();e!==this._currentAudibleTab&&(this._currentAudibleTab=e?a({},e):void 0,this._debounceDelay>0?(clearTimeout(this._debounceTimer),this._debounceTimer=setTimeout(this._currentAudibleTabChanged.bind(this),this._debounceDelay)):this._currentAudibleTabChanged())}},{key:"_currentAudibleTabChanged",value:function(){"function"==typeof this._onCurrentAudibleTabChange&&this._onCurrentAudibleTabChange(this._currentAudibleTab)}},{key:"isStarted",get:function(){return this._started}},{key:"currentAudibleTab",get:function(){return this._currentAudibleTab}},{key:"onCurrentAudibleTabChange",set:function(e){this._onCurrentAudibleTabChange=e}}]),e}();t.default=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),i=function(e){return e&&e.__esModule?e:{default:e}}(n(0));var o=navigator.platform,s=chrome.i18n.getMessage("appName"),r=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:500,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:6e5;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._token=t,this._retryDelay=n,this._closeDelay=a}return a(e,[{key:"sendStatusUpdate",value:function(e){var t=this;clearTimeout(this._retryTimer),clearTimeout(this._closeTimer),this._ws&&this._ws.readyState!==WebSocket.CLOSED?this._ws.readyState===WebSocket.OPEN?this._send(this._getOpStatusUpdatePayload(e)):this._ws.readyState!==WebSocket.CONNECTING&&this._ws.readyState!==WebSocket.CLOSING||(this._retryTimer=setTimeout(function(){return t.sendStatusUpdate(e)},this._retryDelay)):(i.default.loggingEnabled&&console.log("Token "+this._token+": initialize websocket..."),this._ws=new WebSocket("wss://gateway.discord.gg/?v=6&encoding=json"),this._lastSeq=null,this._ws.onopen=function(n){t._send(t._getOpIdentifyPayload(e)),t._identifyStatus=e},this._ws.onmessage=function(e){return t._messageHandler(JSON.parse(e.data))},this._ws.onerror=function(e){return console.log("Token "+t._token+": connection error")},this._ws.onclose=function(e){clearInterval(t._heartbeatTimer),i.default.loggingEnabled&&console.log("Token "+t._token+": connection closed\n - code: "+e.code+"\n - reason: "+e.reason+"\n - wasClean: "+e.wasClean)}),this._closeDelay>0&&(this._closeTimer=setTimeout(this.close,this._closeDelay))}},{key:"close",value:function(){clearTimeout(this._retryTimer),clearTimeout(this._closeTimer),!this._ws||this._ws.readyState!==WebSocket.OPEN&&this._ws.readyState!==WebSocket.CONNECTING||this._ws.close()}},{key:"_send",value:function(e){this._ws.send(JSON.stringify(e)),i.default.loggingEnabled&&console.log("Token "+this._token+": sent "+JSON.stringify(e,null,4))}},{key:"_sendHeartbeat",value:function(){this._ws&&this._ws.readyState===WebSocket.OPEN&&this._send(this._getOpHeartbeatPayload())}},{key:"_messageHandler",value:function(e){switch(this._lastSeq=e.s,e.op){case 1:this._sendHeartbeat(),i.default.loggingEnabled&&console.log("Token "+this._token+": received heartbeat request message: "+JSON.stringify(e,null,4));break;case 10:clearInterval(this._heartbeatTimer),this._heartbeatTimer=setInterval(this._sendHeartbeat.bind(this),e.d.heartbeat_interval),i.default.loggingEnabled&&console.log("Token "+this._token+": received hello message: "+JSON.stringify(e,null,4)),this._identifyStatus||this._send(this._getOpStatusUpdatePayload(this._identifyStatus))}}},{key:"_getOpHeartbeatPayload",value:function(){return{op:1,d:this._lastSeq}}},{key:"_getStatusUpdatePayload",value:function(e){return{game:null===e?null:{name:e,type:2},status:"online",since:null,afk:!1}}},{key:"_getOpIdentifyPayload",value:function(e){return{op:2,d:{token:this._token,properties:{$os:o,$browser:"Chrome",$device:s},compress:!1,large_threshold:50,presence:this._getStatusUpdatePayload(e)}}}},{key:"_getOpStatusUpdatePayload",value:function(e){return{op:3,d:this._getStatusUpdatePayload(e)}}}]),e}();t.default=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}();!function(e){e&&e.__esModule}(n(0));var i={url:"*://discord.com/*"},o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._started=!1,this._listeners={onCreated:this._onTabCreated.bind(this),onUpdated:this._onTabUpdated.bind(this)}}return a(e,[{key:"start",value:function(){if(!this._started){for(var e in this._findTabsTokens(),this._listeners)chrome.tabs[e].addListener(this._listeners[e]);this._started=!0}}},{key:"stop",value:function(){if(this._started){for(var e in this._listeners)chrome.tabs[e].removeListener(this._listeners[e]);this._started=!1}}},{key:"_hostnameMatches",value:function(e){try{return"discord.com"===new URL(e).hostname}catch(e){return!1}}},{key:"_findTabsTokens",value:function(){var e=this;chrome.tabs.query(i,function(t){return t.forEach(function(t){return e._checkTabForToken(t)})})}},{key:"_checkTabForToken",value:function(e){var t=this;chrome.tabs.executeScript(e.id,{code:"localStorage.getItem('token');"},function(e){return e.map(function(e){return JSON.parse(e)}).filter(function(e){return!!e}).forEach(function(e){return t._onFoundCallback(e)})})}},{key:"_onTabCreated",value:function(e){this._hostnameMatches(e.url)&&this._checkTabForToken(e)}},{key:"_onTabUpdated",value:function(e,t,n){this._onTabCreated(n)}},{key:"isStarted",get:function(){return this._started}},{key:"onFound",set:function(e){this._onFoundCallback=e}}]),e}();t.default=o}]);